<!DOCTYPE HTML>
<html lang="zh-CN">


<head>
    <meta charset="utf-8">
    <meta name="keywords" content="Akka实现Spark心跳机制, kanaikee">
    <meta name="description" content="春风不语，即问本心">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <meta name="renderer" content="webkit|ie-stand|ie-comp">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="format-detection" content="telephone=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <!-- Global site tag (gtag.js) - Google Analytics -->


    <title>Akka实现Spark心跳机制 | kanaikee</title>
    <link rel="icon" type="image/png" href="/favicon.png">

    <link rel="stylesheet" type="text/css" href="/libs/awesome/css/all.css">
    <link rel="stylesheet" type="text/css" href="/libs/materialize/materialize.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/aos/aos.css">
    <link rel="stylesheet" type="text/css" href="/libs/animate/animate.min.css">
    <link rel="stylesheet" type="text/css" href="/libs/lightGallery/css/lightgallery.min.css">
    <link rel="stylesheet" type="text/css" href="/css/matery.css">
    <link rel="stylesheet" type="text/css" href="/css/my.css">

    <script src="/libs/jquery/jquery.min.js"></script>

<meta name="generator" content="Hexo 6.1.0"><link rel="stylesheet" href="/css/prism-tomorrow.css" type="text/css"></head>




<body>
    <header class="navbar-fixed">
    <nav id="headNav" class="bg-color nav-transparent">
        <div id="navContainer" class="nav-wrapper container">
            <div class="brand-logo">
                <a href="/" class="waves-effect waves-light">
                    
                    <img src="/medias/logo.png" class="logo-img" alt="LOGO">
                    
                    <span class="logo-span">kanaikee</span>
                </a>
            </div>
            

<a href="#" data-target="mobile-nav" class="sidenav-trigger button-collapse"><i class="fas fa-bars"></i></a>
<ul class="right nav-menu">
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/" class="waves-effect waves-light">
      
      <i class="fas fa-home" style="zoom: 0.6;"></i>
      
      <span>首页</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/tags" class="waves-effect waves-light">
      
      <i class="fas fa-tags" style="zoom: 0.6;"></i>
      
      <span>标签</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/categories" class="waves-effect waves-light">
      
      <i class="fas fa-bookmark" style="zoom: 0.6;"></i>
      
      <span>分类</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/archives" class="waves-effect waves-light">
      
      <i class="fas fa-archive" style="zoom: 0.6;"></i>
      
      <span>归档</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/about" class="waves-effect waves-light">
      
      <i class="fas fa-user-circle" style="zoom: 0.6;"></i>
      
      <span>关于</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/contact" class="waves-effect waves-light">
      
      <i class="fas fa-comments" style="zoom: 0.6;"></i>
      
      <span>留言板</span>
    </a>
    
  </li>
  
  <li class="hide-on-med-and-down nav-item">
    
    <a href="/friends" class="waves-effect waves-light">
      
      <i class="fas fa-address-book" style="zoom: 0.6;"></i>
      
      <span>友情链接</span>
    </a>
    
  </li>
  
  <li>
    <a href="#searchModal" class="modal-trigger waves-effect waves-light">
      <i id="searchIcon" class="fas fa-search" title="搜索" style="zoom: 0.85;"></i>
    </a>
  </li>
</ul>


<div id="mobile-nav" class="side-nav sidenav">

    <div class="mobile-head bg-color">
        
        <img src="/medias/logo.png" class="logo-img circle responsive-img">
        
        <div class="logo-name">kanaikee</div>
        <div class="logo-desc">
            
            春风不语，即问本心
            
        </div>
    </div>

    

    <ul class="menu-list mobile-menu-list">
        
        <li class="m-nav-item">
	  
		<a href="/" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-home"></i>
			
			首页
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/tags" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-tags"></i>
			
			标签
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/categories" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-bookmark"></i>
			
			分类
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/archives" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-archive"></i>
			
			归档
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/about" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-user-circle"></i>
			
			关于
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/contact" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-comments"></i>
			
			留言板
		</a>
          
        </li>
        
        <li class="m-nav-item">
	  
		<a href="/friends" class="waves-effect waves-light">
			
			    <i class="fa-fw fas fa-address-book"></i>
			
			友情链接
		</a>
          
        </li>
        
        
        <li><div class="divider"></div></li>
        <li>
            <a href="https://github.com/blinkfox/hexo-theme-matery" class="waves-effect waves-light" target="_blank">
                <i class="fab fa-github-square fa-fw"></i>Fork Me
            </a>
        </li>
        
    </ul>
</div>


        </div>

        
            <style>
    .nav-transparent .github-corner {
        display: none !important;
    }

    .github-corner {
        position: absolute;
        z-index: 10;
        top: 0;
        right: 0;
        border: 0;
        transform: scale(1.1);
    }

    .github-corner svg {
        color: #0f9d58;
        fill: #fff;
        height: 64px;
        width: 64px;
    }

    .github-corner:hover .octo-arm {
        animation: a 0.56s ease-in-out;
    }

    .github-corner .octo-arm {
        animation: none;
    }

    @keyframes a {
        0%,
        to {
            transform: rotate(0);
        }
        20%,
        60% {
            transform: rotate(-25deg);
        }
        40%,
        80% {
            transform: rotate(10deg);
        }
    }
</style>

<a href="https://github.com/blinkfox/hexo-theme-matery" class="github-corner tooltipped hide-on-med-and-down" target="_blank"
   data-tooltip="Fork Me" data-position="left" data-delay="50">
    <svg viewBox="0 0 250 250" aria-hidden="true">
        <path d="M0,0 L115,115 L130,115 L142,142 L250,250 L250,0 Z"></path>
        <path d="M128.3,109.0 C113.8,99.7 119.0,89.6 119.0,89.6 C122.0,82.7 120.5,78.6 120.5,78.6 C119.2,72.0 123.4,76.3 123.4,76.3 C127.3,80.9 125.5,87.3 125.5,87.3 C122.9,97.6 130.6,101.9 134.4,103.2"
              fill="currentColor" style="transform-origin: 130px 106px;" class="octo-arm"></path>
        <path d="M115.0,115.0 C114.9,115.1 118.7,116.5 119.8,115.4 L133.7,101.6 C136.9,99.2 139.9,98.4 142.2,98.6 C133.8,88.0 127.5,74.4 143.8,58.0 C148.5,53.4 154.0,51.2 159.7,51.0 C160.3,49.4 163.2,43.6 171.4,40.1 C171.4,40.1 176.1,42.5 178.8,56.2 C183.1,58.6 187.2,61.8 190.9,65.4 C194.5,69.0 197.7,73.2 200.1,77.6 C213.8,80.2 216.3,84.9 216.3,84.9 C212.7,93.1 206.9,96.0 205.4,96.6 C205.1,102.4 203.0,107.8 198.3,112.5 C181.9,128.9 168.3,122.5 157.7,114.1 C157.9,116.9 156.7,120.9 152.7,124.9 L141.0,136.5 C139.8,137.7 141.6,141.9 141.8,141.8 Z"
              fill="currentColor" class="octo-body"></path>
    </svg>
</a>
        
    </nav>

</header>

    



<div class="bg-cover pd-header post-cover" style="background-image: url('/medias/featureimages/23.jpg')">
    <div class="container" style="right: 0px;left: 0px;">
        <div class="row">
            <div class="col s12 m12 l12">
                <div class="brand">
                    <h1 class="description center-align post-title">Akka实现Spark心跳机制</h1>
                </div>
            </div>
        </div>
    </div>
</div>




<main class="post-container content">

    
    <link rel="stylesheet" href="/libs/tocbot/tocbot.css">
<style>
    #articleContent h1::before,
    #articleContent h2::before,
    #articleContent h3::before,
    #articleContent h4::before,
    #articleContent h5::before,
    #articleContent h6::before {
        display: block;
        content: " ";
        height: 100px;
        margin-top: -100px;
        visibility: hidden;
    }

    #articleContent :focus {
        outline: none;
    }

    .toc-fixed {
        position: fixed;
        top: 64px;
    }

    .toc-widget {
        width: 345px;
        padding-left: 20px;
    }

    .toc-widget .toc-title {
        padding: 35px 0 15px 17px;
        font-size: 1.5rem;
        font-weight: bold;
        line-height: 1.5rem;
    }

    .toc-widget ol {
        padding: 0;
        list-style: none;
    }

    #toc-content {
        padding-bottom: 30px;
        overflow: auto;
    }

    #toc-content ol {
        padding-left: 10px;
    }

    #toc-content ol li {
        padding-left: 10px;
    }

    #toc-content .toc-link:hover {
        color: #42b983;
        font-weight: 700;
        text-decoration: underline;
    }

    #toc-content .toc-link::before {
        background-color: transparent;
        max-height: 25px;

        position: absolute;
        right: 23.5vw;
        display: block;
    }

    #toc-content .is-active-link {
        color: #42b983;
    }

    #floating-toc-btn {
        position: fixed;
        right: 15px;
        bottom: 76px;
        padding-top: 15px;
        margin-bottom: 0;
        z-index: 998;
    }

    #floating-toc-btn .btn-floating {
        width: 48px;
        height: 48px;
    }

    #floating-toc-btn .btn-floating i {
        line-height: 48px;
        font-size: 1.4rem;
    }
</style>
<div class="row">
    <div id="main-content" class="col s12 m12 l9">
        <!-- 文章内容详情 -->
<div id="artDetail">
    <div class="card">
        <div class="card-content article-info">
            <div class="row tag-cate">
                <div class="col s7">
                    
                    <div class="article-tag">
                        
                            <a href="/tags/Spark/">
                                <span class="chip bg-color">Spark</span>
                            </a>
                        
                    </div>
                    
                </div>
                <div class="col s5 right-align">
                    
                </div>
            </div>

            <div class="post-info">
                
                <div class="post-date info-break-policy">
                    <i class="far fa-calendar-minus fa-fw"></i>发布日期:&nbsp;&nbsp;
                    2022-08-31
                </div>
                

                

                

                

                
            </div>
        </div>
        <hr class="clearfix">

        

        

        <div class="card-content article-card-content">
            <div id="articleContent">
                <h1 id="Akka实现Spark心跳机制"><a href="#Akka实现Spark心跳机制" class="headerlink" title="Akka实现Spark心跳机制"></a>Akka实现Spark心跳机制</h1><p>上文我们已经具体讲解过Spark的心跳机制</p>
<p>在本文我们利用Akka框架来实现一个简易的Spark心跳机制</p>
<p>在文末，会附上具体源码</p>
<p>关于Akka的大致概述及用法可参考这位大佬的链接：<a target="_blank" rel="noopener" href="https://juejin.cn/post/6977713688560009246">https://juejin.cn/post/6977713688560009246</a></p>
<p>本文源码主要为 ifIAmADJ 这位大佬的<a target="_blank" rel="noopener" href="https://github.com/ifIAmADJ/scala_spark">源码</a>，但是可能是Akka版本关系，运行端口会报错，所以在此基础上做了些许改动</p>
<h2 id="具体实现"><a href="#具体实现" class="headerlink" title="具体实现"></a>具体实现</h2><hr>
<h3 id="目录结构"><a href="#目录结构" class="headerlink" title="目录结构"></a>目录结构</h3><pre class=" language-bash"><code class="language-bash">└─heartbeat
    ├─common
    │      HeartBeat.scala
    │      RegisteredWorkerInfo.scala
    │      RegisterWorkerInfo.scala
    │      RemoveTimeOutWorker.scala
    │      SendHeartBeat.scala
    │      StartTimeOutWorker.scala
    │      WorkerInfo.scala
    │
    ├─master
    │      SparkMaster.scala
    │
    └─worker
            SparkWorker.scala
</code></pre>
<p>其中 </p>
<p><code>common</code> 中放置一些心跳传递的相关类</p>
<p><code>master</code> 存放伪Master节点</p>
<p><code>worker</code> 存放伪Worker节点</p>
<h3 id="依赖"><a href="#依赖" class="headerlink" title="依赖"></a>依赖</h3><p>build.sbt 文件</p>
<pre class=" language-scala"><code class="language-scala">ThisBuild <span class="token operator">/</span> version <span class="token operator">:</span><span class="token operator">=</span> <span class="token string">"0.1.0-SNAPSHOT"</span>

ThisBuild <span class="token operator">/</span> scalaVersion <span class="token operator">:</span><span class="token operator">=</span> <span class="token string">"2.13.8"</span>

resolvers <span class="token operator">+=</span> <span class="token string">"Typesafe Repository"</span> at <span class="token string">"https://maven.aliyun.com/repository/public/"</span>

<span class="token keyword">lazy</span> <span class="token keyword">val</span> root <span class="token operator">=</span> <span class="token punctuation">(</span>project in file<span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">.</span>settings<span class="token punctuation">(</span>
    name <span class="token operator">:</span><span class="token operator">=</span> <span class="token string">"Akka"</span>
  <span class="token punctuation">)</span>

<span class="token keyword">val</span> AkkaVersion <span class="token operator">=</span> <span class="token string">"2.6.19"</span>

libraryDependencies <span class="token operator">+=</span> <span class="token string">"com.typesafe.akka"</span> <span class="token operator">%</span><span class="token operator">%</span> <span class="token string">"akka-actor"</span> <span class="token operator">%</span> AkkaVersion
libraryDependencies <span class="token operator">+=</span> <span class="token string">"com.typesafe.akka"</span> <span class="token operator">%</span><span class="token operator">%</span> <span class="token string">"akka-remote"</span> <span class="token operator">%</span> AkkaVersion
</code></pre>
<h3 id="common-包"><a href="#common-包" class="headerlink" title="common 包"></a>common 包</h3><pre class=" language-scala"><code class="language-scala"><span class="token comment" spellcheck="true">/**
 * worker 收到 SendHeartBeat 时，向 master 发送对应的心跳信息，并标注自己的 id
 *
 * @param id
 */</span>
<span class="token keyword">case</span> <span class="token keyword">class</span> HeartBeat<span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">)</span> <span class="token keyword">extends</span> Serializable
</code></pre>
<pre class=" language-scala"><code class="language-scala"><span class="token comment" spellcheck="true">/**
 * 当注册成功时，返回这个单例对象。
 *
 * case object 和 case class 的区别是：
 * case object 不具备 apply, unapply 方法。
 *
 */</span>
<span class="token keyword">case</span> <span class="token keyword">object</span> RegisteredWorkerInfo <span class="token keyword">extends</span> Serializable
</code></pre>
<pre class=" language-scala"><code class="language-scala"><span class="token comment" spellcheck="true">/**
 * worker 注册时发送给服务器的信息。
 *
 * @param id
 * @param cpu
 * @param ram
 */</span>
<span class="token keyword">case</span> <span class="token keyword">class</span> RegisterWorkerInfo<span class="token punctuation">(</span>id<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> cpu<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> ram<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token keyword">extends</span> Serializable
</code></pre>
<pre class=" language-scala"><code class="language-scala"><span class="token comment" spellcheck="true">/**
 * AKka 上下文通过计时器提醒 master 删除过期的 workers 时，发送此单例对象。
 */</span>
<span class="token keyword">case</span> <span class="token keyword">object</span> RemoveTimeOutWorker <span class="token keyword">extends</span> Serializable
</code></pre>
<pre class=" language-scala"><code class="language-scala"><span class="token comment" spellcheck="true">/**
 * Akka 上下文通过计时器提醒 worker 发送心跳信息时，发送此单例对象。
 */</span>
<span class="token keyword">case</span> <span class="token keyword">object</span> SendHeartBeat <span class="token keyword">extends</span> Serializable
</code></pre>
<pre class=" language-scala"><code class="language-scala"><span class="token comment" spellcheck="true">/**
 * master 在启动时会向自己发送此单例对象，来触发定期检查机制。
 */</span>
<span class="token keyword">case</span> <span class="token keyword">object</span> StartTimeOutWorker <span class="token keyword">extends</span> Serializable
</code></pre>
<pre class=" language-scala"><code class="language-scala"><span class="token comment" spellcheck="true">/**
 * 这个结构体用于 master 将每个注册的 worker 信息保存到 hashMap 当中。
 *
 * 为什么 master 不直接存放 RegisterWorkerInfo 呢？
 * 在之后，WorkerInfo 会进行拓展。（比如增加 worker 上一次的心跳时间）
 *
 * @param id
 * @param cpu
 * @param ram
 */</span>
<span class="token keyword">class</span> WorkerInfo<span class="token punctuation">(</span><span class="token keyword">val</span> id<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> <span class="token keyword">val</span> cpu<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">,</span> <span class="token keyword">val</span> ram<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token keyword">extends</span> Serializable <span class="token punctuation">{</span>

  <span class="token comment" spellcheck="true">// 拓展：需要记录每个 worker 上次发送心跳消息的信息。</span>
  <span class="token keyword">var</span> lastHeartBeat<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> System<span class="token punctuation">.</span>currentTimeMillis<span class="token punctuation">(</span><span class="token punctuation">)</span>

<span class="token punctuation">}</span>
</code></pre>
<h3 id="master-包"><a href="#master-包" class="headerlink" title="master 包"></a>master 包</h3><pre class=" language-scala"><code class="language-scala"><span class="token keyword">import</span> akka<span class="token punctuation">.</span>actor<span class="token punctuation">.</span><span class="token punctuation">{</span>Actor<span class="token punctuation">,</span> ActorRef<span class="token punctuation">,</span> ActorSystem<span class="token punctuation">,</span> Props<span class="token punctuation">}</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>heartbeat<span class="token punctuation">.</span>common<span class="token punctuation">.</span>_
<span class="token keyword">import</span> com<span class="token punctuation">.</span>typesafe<span class="token punctuation">.</span>config<span class="token punctuation">.</span>ConfigFactory

<span class="token keyword">import</span> scala<span class="token punctuation">.</span>collection<span class="token punctuation">.</span>mutable
<span class="token keyword">import</span> scala<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>duration<span class="token punctuation">.</span>_
<span class="token keyword">import</span> scala<span class="token punctuation">.</span>language<span class="token punctuation">.</span>postfixOps

<span class="token keyword">class</span> SparkMaster <span class="token keyword">extends</span> Actor <span class="token punctuation">{</span>


  <span class="token comment" spellcheck="true">//定义一个管理 worker 信息的 hashMap ， 这个 hashMap 必须是可变的。</span>
  <span class="token keyword">val</span> workers<span class="token operator">:</span> mutable<span class="token punctuation">.</span>Map<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> WorkerInfo<span class="token punctuation">]</span> <span class="token operator">=</span> mutable<span class="token punctuation">.</span>Map<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">,</span> WorkerInfo<span class="token punctuation">]</span><span class="token punctuation">(</span><span class="token punctuation">)</span>

  <span class="token keyword">override</span> <span class="token keyword">def</span> receive<span class="token operator">:</span> Receive <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">"start"</span> <span class="token keyword">=></span>
      println<span class="token punctuation">(</span><span class="token string">" Master 服务器启动成功！"</span><span class="token punctuation">)</span>

      <span class="token comment" spellcheck="true">// 自启动 workers 的定时检查机制。</span>
      <span class="token keyword">self</span> <span class="token operator">!</span> StartTimeOutWorker

    <span class="token keyword">case</span> RegisterWorkerInfo<span class="token punctuation">(</span>id<span class="token punctuation">,</span> cpu<span class="token punctuation">,</span> ram<span class="token punctuation">)</span> <span class="token keyword">=></span>
      <span class="token comment" spellcheck="true">//接受到客户端的注册信息</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>workers<span class="token punctuation">.</span>contains<span class="token punctuation">(</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment" spellcheck="true">//提取该 worker 的基本信息。</span>
        <span class="token keyword">val</span> workerInfo <span class="token operator">=</span> <span class="token keyword">new</span> WorkerInfo<span class="token punctuation">(</span>id<span class="token punctuation">,</span> cpu<span class="token punctuation">,</span> ram<span class="token punctuation">)</span>

        workers <span class="token operator">+=</span> <span class="token punctuation">(</span>id <span class="token operator">-</span><span class="token operator">></span> workerInfo<span class="token punctuation">)</span>

        <span class="token comment" spellcheck="true">//一切操作完成时，直接返回该单例对象（伴生类）</span>
        sender<span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">!</span> RegisteredWorkerInfo
      <span class="token punctuation">}</span>

    <span class="token keyword">case</span> HeartBeat<span class="token punctuation">(</span>id<span class="token punctuation">)</span> <span class="token keyword">=></span>
      <span class="token comment" spellcheck="true">// 更新指定 id worker 的信息。</span>
      <span class="token comment" spellcheck="true">// 1.取出消息</span>
      <span class="token keyword">val</span> info<span class="token operator">:</span> WorkerInfo <span class="token operator">=</span> workers<span class="token punctuation">(</span>id<span class="token punctuation">)</span>

      <span class="token comment" spellcheck="true">// 2.更新时间</span>
      info<span class="token punctuation">.</span>lastHeartBeat <span class="token operator">=</span> System<span class="token punctuation">.</span>currentTimeMillis<span class="token punctuation">(</span><span class="token punctuation">)</span>

      workers <span class="token operator">+=</span> id <span class="token operator">-</span><span class="token operator">></span> info

      println<span class="token punctuation">(</span>s<span class="token string">"Worker id : $id 的信息更新了！"</span><span class="token punctuation">)</span>

    <span class="token keyword">case</span> StartTimeOutWorker <span class="token keyword">=></span>
      println<span class="token punctuation">(</span><span class="token string">"准备定期检测 worker 心跳："</span><span class="token punctuation">)</span>
      <span class="token keyword">import</span> context<span class="token punctuation">.</span>dispatcher

      context<span class="token punctuation">.</span>system<span class="token punctuation">.</span>scheduler<span class="token punctuation">.</span>scheduleWithFixedDelay<span class="token punctuation">(</span><span class="token number">0</span> millis<span class="token punctuation">,</span> <span class="token number">9000</span> millis<span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">,</span> RemoveTimeOutWorker<span class="token punctuation">)</span>

    <span class="token keyword">case</span> RemoveTimeOutWorker <span class="token keyword">=></span>

      <span class="token keyword">val</span> now<span class="token operator">:</span> <span class="token builtin">Long</span> <span class="token operator">=</span> System<span class="token punctuation">.</span>currentTimeMillis<span class="token punctuation">(</span><span class="token punctuation">)</span>

      <span class="token comment" spellcheck="true">// 检查哪些 worker 心跳超时了，从 hashMap 当中删除。</span>
      <span class="token comment" spellcheck="true">// 利用 Scala 的函数式编程来解决问题。</span>
      <span class="token comment" spellcheck="true">// 1. 筛选出超时的 workers</span>
      <span class="token comment" spellcheck="true">// 2. 将这些 workers 从 hashMap当中移除。</span>
      <span class="token comment" spellcheck="true">//</span>
      <span class="token comment" spellcheck="true">// 判断超时的逻辑：</span>
      <span class="token comment" spellcheck="true">// (now - specified_id_worker's lastHeartBeat) > threshold 。</span>
      <span class="token comment" spellcheck="true">// 由于网络传输存在一些少数的延迟(一般集群都在局域网内)，这个 threshold 我们选取 6 秒。</span>

      workers<span class="token punctuation">.</span>values<span class="token punctuation">.</span>filter<span class="token punctuation">(</span>worker <span class="token keyword">=></span> now <span class="token operator">-</span> worker<span class="token punctuation">.</span>lastHeartBeat <span class="token operator">></span> <span class="token number">6000</span><span class="token punctuation">)</span>
        <span class="token punctuation">.</span>foreach<span class="token punctuation">(</span>worker <span class="token keyword">=></span> workers<span class="token punctuation">.</span>remove<span class="token punctuation">(</span>worker<span class="token punctuation">.</span>id<span class="token punctuation">)</span><span class="token punctuation">)</span>

      println<span class="token punctuation">(</span><span class="token string">"当前有"</span> <span class="token operator">+</span> workers<span class="token punctuation">.</span>size <span class="token operator">+</span> <span class="token string">"个 workers 存活。"</span><span class="token punctuation">)</span>

  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token keyword">object</span> SparkMaster <span class="token punctuation">{</span>
  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>

    <span class="token comment" spellcheck="true">//1.绑定本机地址和启动的端口号</span>
    <span class="token keyword">val</span> host <span class="token operator">=</span> <span class="token string">"127.0.0.1"</span> <span class="token comment" spellcheck="true">//绑定为本机地址</span>
    <span class="token keyword">val</span> port <span class="token operator">=</span> <span class="token number">9999</span> <span class="token comment" spellcheck="true">//绑定本机启动的端口号</span>

    <span class="token comment" spellcheck="true">//2.绑定配置文件</span>
    <span class="token keyword">val</span> config <span class="token operator">=</span> ConfigFactory<span class="token punctuation">.</span>parseString<span class="token punctuation">(</span>
      s<span class="token string">"""
         |akka.actor.provider="akka.remote.RemoteActorRefProvider"
         |akka.remote.artery.enable="on"
         |akka.remote.artery.canonical.hostname=$host
         |akka.remote.artery.canonical.port=$port
         |akka.actor.allow-java-serialization=on
         |"""</span><span class="token punctuation">.</span>stripMargin
    <span class="token punctuation">)</span>

    <span class="token keyword">val</span> sparkMasterSystem <span class="token operator">=</span> ActorSystem<span class="token punctuation">(</span><span class="token string">"master"</span><span class="token punctuation">,</span> config <span class="token operator">=</span> config<span class="token punctuation">)</span>

    <span class="token keyword">val</span> sparkMasterRef<span class="token operator">:</span> ActorRef <span class="token operator">=</span> sparkMasterSystem<span class="token punctuation">.</span>actorOf<span class="token punctuation">(</span>Props<span class="token punctuation">[</span>SparkMaster<span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token string">"SparkMaster-01"</span><span class="token punctuation">)</span>

    sparkMasterRef <span class="token operator">!</span> <span class="token string">"start"</span>

  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h3 id="worker-包"><a href="#worker-包" class="headerlink" title="worker 包"></a>worker 包</h3><pre class=" language-scala"><code class="language-scala"><span class="token keyword">import</span> akka<span class="token punctuation">.</span>actor<span class="token punctuation">.</span><span class="token punctuation">{</span>Actor<span class="token punctuation">,</span> ActorRef<span class="token punctuation">,</span> ActorSelection<span class="token punctuation">,</span> ActorSystem<span class="token punctuation">,</span> Props<span class="token punctuation">}</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>spark<span class="token punctuation">.</span>heartbeat<span class="token punctuation">.</span>common<span class="token punctuation">.</span><span class="token punctuation">{</span>HeartBeat<span class="token punctuation">,</span> RegisterWorkerInfo<span class="token punctuation">,</span> RegisteredWorkerInfo<span class="token punctuation">,</span> SendHeartBeat<span class="token punctuation">}</span>
<span class="token keyword">import</span> com<span class="token punctuation">.</span>typesafe<span class="token punctuation">.</span>config<span class="token punctuation">.</span>ConfigFactory

<span class="token keyword">import</span> scala<span class="token punctuation">.</span>concurrent<span class="token punctuation">.</span>duration<span class="token punctuation">.</span>_
<span class="token keyword">import</span> scala<span class="token punctuation">.</span>language<span class="token punctuation">.</span>postfixOps

<span class="token keyword">class</span> SparkWorker<span class="token punctuation">(</span>masterHost<span class="token operator">:</span> <span class="token builtin">String</span><span class="token punctuation">,</span> masterPort<span class="token operator">:</span> <span class="token builtin">Int</span><span class="token punctuation">)</span> <span class="token keyword">extends</span> Actor <span class="token punctuation">{</span>

  <span class="token comment" spellcheck="true">// 实际上就是 ActorRef 的另一种叫法。</span>
  <span class="token keyword">var</span> masterProxy<span class="token operator">:</span> ActorSelection <span class="token operator">=</span> _

  <span class="token comment" spellcheck="true">// 每个 Worker 生成一个随机 id。</span>
  <span class="token keyword">val</span> id<span class="token operator">:</span> <span class="token builtin">String</span> <span class="token operator">=</span> java<span class="token punctuation">.</span>util<span class="token punctuation">.</span>UUID<span class="token punctuation">.</span>randomUUID<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span>toString

  <span class="token comment" spellcheck="true">// 初始化 Master 的 Proxy。</span>
  <span class="token keyword">override</span> <span class="token keyword">def</span> preStart<span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>
    masterProxy <span class="token operator">=</span> context<span class="token punctuation">.</span>actorSelection<span class="token punctuation">(</span>
      s<span class="token string">"akka://master@$masterHost:$masterPort/user/SparkMaster-01"</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">override</span> <span class="token keyword">def</span> receive<span class="token operator">:</span> Receive <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">case</span> <span class="token string">"start"</span> <span class="token keyword">=></span>
      println<span class="token punctuation">(</span><span class="token string">" Worker 服务器启动成功!"</span><span class="token punctuation">)</span>
      masterProxy <span class="token operator">!</span> RegisterWorkerInfo<span class="token punctuation">(</span>id<span class="token punctuation">,</span> <span class="token number">8</span><span class="token punctuation">,</span> <span class="token number">16</span> <span class="token operator">*</span> <span class="token number">1024</span><span class="token punctuation">)</span>
    <span class="token keyword">case</span> RegisteredWorkerInfo <span class="token keyword">=></span>

      println<span class="token punctuation">(</span>s<span class="token string">" Worker : $id 注册成功了!"</span><span class="token punctuation">)</span>

      <span class="token comment" spellcheck="true">//注册成功之后，定义一个计时器，每隔一段时间发送消息。</span>
      <span class="token keyword">import</span> context<span class="token punctuation">.</span>dispatcher

      <span class="token comment" spellcheck="true">/*
      1. initialDelay:初始延迟。设定当 worker 收到注册成功的消息之后，立刻发送一次心跳检测。
      2. internalDelay:时间间隔。设定每 3000 毫秒发送一次心跳消息。
      3. actorRef:本机的 actor 系统将向哪个 actor 发送消息。
      4. message:发送消息的内容。
      其逻辑是：本机的 Akka 系统通过计时器"提醒"此 worker 发送心跳消息，
      然后 worker 收到此"提醒"之后，再向 master 发送真正的心跳消息。
       */</span>
      context<span class="token punctuation">.</span>system<span class="token punctuation">.</span>scheduler<span class="token punctuation">.</span>scheduleWithFixedDelay<span class="token punctuation">(</span><span class="token number">0</span> millis<span class="token punctuation">,</span> <span class="token number">3000</span> millis<span class="token punctuation">,</span> <span class="token keyword">self</span><span class="token punctuation">,</span> SendHeartBeat<span class="token punctuation">)</span>

    <span class="token keyword">case</span> SendHeartBeat <span class="token keyword">=></span>

      println<span class="token punctuation">(</span>s<span class="token string">" Worker : $id 发送了心跳信息。"</span><span class="token punctuation">)</span>
      masterProxy <span class="token operator">!</span> HeartBeat<span class="token punctuation">(</span>id<span class="token punctuation">)</span>

  <span class="token punctuation">}</span>


<span class="token punctuation">}</span>

<span class="token keyword">object</span> SparkWorker <span class="token punctuation">{</span>

  <span class="token keyword">def</span> main<span class="token punctuation">(</span>args<span class="token operator">:</span> Array<span class="token punctuation">[</span><span class="token builtin">String</span><span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token operator">:</span> <span class="token builtin">Unit</span> <span class="token operator">=</span> <span class="token punctuation">{</span>

    <span class="token comment" spellcheck="true">//1.绑定本机地址和启动的端口号</span>
    <span class="token keyword">val</span> workerHost <span class="token operator">=</span> <span class="token string">"127.0.0.1"</span> <span class="token comment" spellcheck="true">//绑定为本机地址</span>
    <span class="token keyword">val</span> workerPort <span class="token operator">=</span> <span class="token number">10001</span> <span class="token comment" spellcheck="true">//绑定本机启动的端口号</span>

    <span class="token comment" spellcheck="true">//1.1 配置远端地址和启动的端口号</span>
    <span class="token keyword">val</span> masterHost <span class="token operator">=</span> <span class="token string">"127.0.0.1"</span>
    <span class="token keyword">val</span> masterPort <span class="token operator">=</span> <span class="token number">9999</span>


    <span class="token comment" spellcheck="true">//2.绑定配置文件</span>
    <span class="token keyword">val</span> config <span class="token operator">=</span> ConfigFactory<span class="token punctuation">.</span>parseString<span class="token punctuation">(</span>
      s<span class="token string">"""
         |akka.actor.provider="akka.remote.RemoteActorRefProvider"
         |akka.remote.artery.enable="on"
         |akka.remote.artery.canonical.hostname=$workerHost
         |akka.remote.artery.canonical.port=$workerPort
         |akka.actor.allow-java-serialization=on
         |"""</span><span class="token punctuation">.</span>stripMargin
    <span class="token punctuation">)</span>


    <span class="token keyword">val</span> workerSystem <span class="token operator">=</span> ActorSystem<span class="token punctuation">(</span><span class="token string">"worker"</span><span class="token punctuation">,</span> config <span class="token operator">=</span> config<span class="token punctuation">)</span>

    <span class="token keyword">val</span> sparkWorkerActorRef<span class="token operator">:</span> ActorRef <span class="token operator">=</span> workerSystem<span class="token punctuation">.</span>actorOf<span class="token punctuation">(</span>Props<span class="token punctuation">(</span><span class="token keyword">new</span> SparkWorker<span class="token punctuation">(</span>masterHost<span class="token punctuation">,</span> masterPort<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token string">"SparkWorker"</span><span class="token punctuation">)</span>

    sparkWorkerActorRef <span class="token operator">!</span> <span class="token string">"start"</span>

  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre>
<h2 id="Akka-和-Spark-的纠葛"><a href="#Akka-和-Spark-的纠葛" class="headerlink" title="Akka 和 Spark 的纠葛"></a>Akka 和 Spark 的纠葛</h2><p>从上文可以看出，Akka用来实现Spark的心跳机制十分方便</p>
<p>Spark 在 Spark 2.x 以前是支持Akko作为内部通信的，但是从Spark 2.x 开始，就不再支持 Akka 了</p>
<p>那是因为</p>
<p>在 Spark 1.3 年代，为了解决大块数据（如Shuffle）的传输问题，Spark引入了Netty通信框架。但是从 Spark 1.6， Spark 可以配置使用 Akka 或者 Netty 了，这意味着 Netty 可以完全替代 Akka 了。再到 Spark 2, Spark 已经完全抛弃 Akka 了，全部使用 Netty 了。</p>
<p>为什么 Spark 无情地有步骤有预谋地抛弃 Akka 呢？Spark 官方倒是给了一个说法:<a target="_blank" rel="noopener" href="https://issues.apache.org/jira/browse/SPARK-5293%E3%80%82">https://issues.apache.org/jira/browse/SPARK-5293。</a></p>
<blockquote>
<p>A lot of Spark user applications are using (or want to use) Akka. Akka as a whole can contribute great architectural simplicity and uniformity. However, because Spark depends on Akka, it is not possible for users to rely on different versions, and we have received many requests in the past asking for help about this specific issue. For example, Spark Streaming might be used as the receiver of Akka messages - but our dependency on Akka requires the upstream Akka actors to also use the identical version of Akka.</p>
<p>Since our usage of Akka is limited (mainly for RPC and single-threaded event loop), we can replace it with alternative RPC implementations and a common event loop in Spark.</p>
</blockquote>
<p><em>谷歌机翻</em></p>
<blockquote>
<p>许多SPARK用户应用程序都使用（或想要使用）AKKA。Akka从整体上可以贡献出极大的建筑简单性和统一性。但是，由于Spark取决于Akka，因此用户不可能依靠不同的版本，并且过去我们收到了许多请求，请求有关此特定问题的帮助。例如，Spark流可以用作AKKA消息的接收器 - 但是我们对Akka的依赖性要求上游Akka Actors也可以使用相同的Akka版本。由于我们对Akka的使用受到限制（主要用于RPC和单线读取事件循环），因此我们可以将其替换为Spark中的替代RPC实现和一个常见的事件循环。</p>
</blockquote>
<p>大意就是很多 Spark 用户在使用 Spark 之后，就必须使用 Spark 依赖的那个版本的 Akka。Spark 主要用了 Akka 的 RPC 和 单线程 event-loop，因此 Spark 没有必要依赖完全的 Akka。最终 Spark 用 netty 实现下简易版本的 Akka。</p>
<p>源码：<a target="_blank" rel="noopener" href="https://kanaikee.jetbrains.space/p/spark-akka-heartbeat/repositories/spark-akka-heartbeat/files">https://kanaikee.jetbrains.space/p/spark-akka-heartbeat/repositories/spark-akka-heartbeat/files</a></p>

                
            </div>
            <hr/>

            

    <div class="reprint" id="reprint-statement">
        
            <div class="reprint__author">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-user">
                        文章作者:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="/about" rel="external nofollow noreferrer">kanaikee</a>
                </span>
            </div>
            <div class="reprint__type">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-link">
                        文章链接:
                    </i>
                </span>
                <span class="reprint-info">
                    <a href="http://kanaikee.com/2022/08/31/akka-shi-xian-spark-xin-tiao-ji-zhi/">http://kanaikee.com/2022/08/31/akka-shi-xian-spark-xin-tiao-ji-zhi/</a>
                </span>
            </div>
            <div class="reprint__notice">
                <span class="reprint-meta" style="font-weight: bold;">
                    <i class="fas fa-copyright">
                        版权声明:
                    </i>
                </span>
                <span class="reprint-info">
                    本博客所有文章除特別声明外，均采用
                    <a href="https://creativecommons.org/licenses/by/4.0/deed.zh" rel="external nofollow noreferrer" target="_blank">CC BY 4.0</a>
                    许可协议。转载请注明来源
                    <a href="/about" target="_blank">kanaikee</a>
                    !
                </span>
            </div>
        
    </div>

    <script async defer>
      document.addEventListener("copy", function (e) {
        let toastHTML = '<span>复制成功，请遵循本文的转载规则</span><button class="btn-flat toast-action" onclick="navToReprintStatement()" style="font-size: smaller">查看</a>';
        M.toast({html: toastHTML})
      });

      function navToReprintStatement() {
        $("html, body").animate({scrollTop: $("#reprint-statement").offset().top - 80}, 800);
      }
    </script>



            <div class="tag_share" style="display: block;">
                <div class="post-meta__tag-list" style="display: inline-block;">
                    
                        <div class="article-tag">
                            
                                <a href="/tags/Spark/">
                                    <span class="chip bg-color">Spark</span>
                                </a>
                            
                        </div>
                    
                </div>
                <div class="post_share" style="zoom: 80%; width: fit-content; display: inline-block; float: right; margin: -0.15rem 0;">
                    <link rel="stylesheet" type="text/css" href="/libs/share/css/share.min.css">
<div id="article-share">

    
    <div class="social-share" data-sites="twitter,facebook,google,qq,qzone,wechat,weibo,douban,linkedin" data-wechat-qrcode-helper="<p>微信扫一扫即可分享！</p>"></div>
    <script src="/libs/share/js/social-share.min.js"></script>
    

    

</div>

                </div>
            </div>
            
                <style>
    #reward {
        margin: 40px 0;
        text-align: center;
    }

    #reward .reward-link {
        font-size: 1.4rem;
        line-height: 38px;
    }

    #reward .btn-floating:hover {
        box-shadow: 0 6px 12px rgba(0, 0, 0, 0.2), 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    #rewardModal {
        width: 320px;
        height: 350px;
    }

    #rewardModal .reward-title {
        margin: 15px auto;
        padding-bottom: 5px;
    }

    #rewardModal .modal-content {
        padding: 10px;
    }

    #rewardModal .close {
        position: absolute;
        right: 15px;
        top: 15px;
        color: rgba(0, 0, 0, 0.5);
        font-size: 1.3rem;
        line-height: 20px;
        cursor: pointer;
    }

    #rewardModal .close:hover {
        color: #ef5350;
        transform: scale(1.3);
        -moz-transform:scale(1.3);
        -webkit-transform:scale(1.3);
        -o-transform:scale(1.3);
    }

    #rewardModal .reward-tabs {
        margin: 0 auto;
        width: 210px;
    }

    .reward-tabs .tabs {
        height: 38px;
        margin: 10px auto;
        padding-left: 0;
    }

    .reward-content ul {
        padding-left: 0 !important;
    }

    .reward-tabs .tabs .tab {
        height: 38px;
        line-height: 38px;
    }

    .reward-tabs .tab a {
        color: #fff;
        background-color: #ccc;
    }

    .reward-tabs .tab a:hover {
        background-color: #ccc;
        color: #fff;
    }

    .reward-tabs .wechat-tab .active {
        color: #fff !important;
        background-color: #22AB38 !important;
    }

    .reward-tabs .alipay-tab .active {
        color: #fff !important;
        background-color: #019FE8 !important;
    }

    .reward-tabs .reward-img {
        width: 210px;
        height: 210px;
    }
</style>

<div id="reward">
    <a href="#rewardModal" class="reward-link modal-trigger btn-floating btn-medium waves-effect waves-light red">赏</a>

    <!-- Modal Structure -->
    <div id="rewardModal" class="modal">
        <div class="modal-content">
            <a class="close modal-close"><i class="fas fa-times"></i></a>
            <h4 class="reward-title">你的赏识是我前进的动力</h4>
            <div class="reward-content">
                <div class="reward-tabs">
                    <ul class="tabs row">
                        <li class="tab col s6 alipay-tab waves-effect waves-light"><a href="#alipay">支付宝</a></li>
                        <li class="tab col s6 wechat-tab waves-effect waves-light"><a href="#wechat">微 信</a></li>
                    </ul>
                    <div id="alipay">
                        <img src="/medias/reward/alipay.jpg" class="reward-img" alt="支付宝打赏二维码">
                    </div>
                    <div id="wechat">
                        <img src="/medias/reward/wechat.png" class="reward-img" alt="微信打赏二维码">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    $(function () {
        $('.tabs').tabs();
    });
</script>

            
        </div>
    </div>

    

    

    

    

    

    

    

    

<article id="prenext-posts" class="prev-next articles">
    <div class="row article-row">
        
        <div class="article col s12 m6" data-aos="fade-up" data-aos="fade-up">
            <div class="article-badge left-badge text-color">
                <i class="far fa-dot-circle"></i>&nbsp;本篇
            </div>
            <div class="card">
                <a href="/2022/08/31/akka-shi-xian-spark-xin-tiao-ji-zhi/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/23.jpg" class="responsive-img" alt="Akka实现Spark心跳机制">
                        
                        <span class="card-title">Akka实现Spark心跳机制</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2022-08-31
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            kanaikee
                            
                        </span>
                    </div>
                </div>

                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Spark/">
                        <span class="chip bg-color">Spark</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
        
        <div class="article col s12 m6" data-aos="fade-up">
            <div class="article-badge right-badge text-color">
                下一篇&nbsp;<i class="fas fa-chevron-right"></i>
            </div>
            <div class="card">
                <a href="/2022/08/31/spark-xin-tiao-ji-zhi/">
                    <div class="card-image">
                        
                        
                        <img src="/medias/featureimages/1.jpg" class="responsive-img" alt="Spark 心跳机制">
                        
                        <span class="card-title">Spark 心跳机制</span>
                    </div>
                </a>
                <div class="card-content article-content">
                    <div class="summary block-with-text">
                        
                            
                        
                    </div>
                    <div class="publish-info">
                            <span class="publish-date">
                                <i class="far fa-clock fa-fw icon-date"></i>2022-08-31
                            </span>
                        <span class="publish-author">
                            
                            <i class="fas fa-user fa-fw"></i>
                            kanaikee
                            
                        </span>
                    </div>
                </div>
                
                <div class="card-action article-tags">
                    
                    <a href="/tags/Spark/">
                        <span class="chip bg-color">Spark</span>
                    </a>
                    
                </div>
                
            </div>
        </div>
        
    </div>
</article>

</div>



<!-- 代码块功能依赖 -->
<script type="text/javascript" src="/libs/codeBlock/codeBlockFuction.js"></script>

<!-- 代码语言 -->

<script type="text/javascript" src="/libs/codeBlock/codeLang.js"></script>


<!-- 代码块复制 -->

<script type="text/javascript" src="/libs/codeBlock/codeCopy.js"></script>


<!-- 代码块收缩 -->

<script type="text/javascript" src="/libs/codeBlock/codeShrink.js"></script>


    </div>
    <div id="toc-aside" class="expanded col l3 hide-on-med-and-down">
        <div class="toc-widget card" style="background-color: white;">
            <div class="toc-title"><i class="far fa-list-alt"></i>&nbsp;&nbsp;目录</div>
            <div id="toc-content"></div>
        </div>
    </div>
</div>

<!-- TOC 悬浮按钮. -->

<div id="floating-toc-btn" class="hide-on-med-and-down">
    <a class="btn-floating btn-large bg-color">
        <i class="fas fa-list-ul"></i>
    </a>
</div>


<script src="/libs/tocbot/tocbot.min.js"></script>
<script>
    $(function () {
        tocbot.init({
            tocSelector: '#toc-content',
            contentSelector: '#articleContent',
            headingsOffset: -($(window).height() * 0.4 - 45),
            collapseDepth: Number('0'),
            headingSelector: 'h2, h3, h4'
        });

        // modify the toc link href to support Chinese.
        let i = 0;
        let tocHeading = 'toc-heading-';
        $('#toc-content a').each(function () {
            $(this).attr('href', '#' + tocHeading + (++i));
        });

        // modify the heading title id to support Chinese.
        i = 0;
        $('#articleContent').children('h2, h3, h4').each(function () {
            $(this).attr('id', tocHeading + (++i));
        });

        // Set scroll toc fixed.
        let tocHeight = parseInt($(window).height() * 0.4 - 64);
        let $tocWidget = $('.toc-widget');
        $(window).scroll(function () {
            let scroll = $(window).scrollTop();
            /* add post toc fixed. */
            if (scroll > tocHeight) {
                $tocWidget.addClass('toc-fixed');
            } else {
                $tocWidget.removeClass('toc-fixed');
            }
        });

        
        /* 修复文章卡片 div 的宽度. */
        let fixPostCardWidth = function (srcId, targetId) {
            let srcDiv = $('#' + srcId);
            if (srcDiv.length === 0) {
                return;
            }

            let w = srcDiv.width();
            if (w >= 450) {
                w = w + 21;
            } else if (w >= 350 && w < 450) {
                w = w + 18;
            } else if (w >= 300 && w < 350) {
                w = w + 16;
            } else {
                w = w + 14;
            }
            $('#' + targetId).width(w);
        };

        // 切换TOC目录展开收缩的相关操作.
        const expandedClass = 'expanded';
        let $tocAside = $('#toc-aside');
        let $mainContent = $('#main-content');
        $('#floating-toc-btn .btn-floating').click(function () {
            if ($tocAside.hasClass(expandedClass)) {
                $tocAside.removeClass(expandedClass).hide();
                $mainContent.removeClass('l9');
            } else {
                $tocAside.addClass(expandedClass).show();
                $mainContent.addClass('l9');
            }
            fixPostCardWidth('artDetail', 'prenext-posts');
        });
        
    });
</script>

    

</main>




    <footer class="page-footer bg-color">
    
        <link rel="stylesheet" href="/libs/aplayer/APlayer.min.css">
<style>
    .aplayer .aplayer-lrc p {
        
        display: none;
        
        font-size: 12px;
        font-weight: 700;
        line-height: 16px !important;
    }

    .aplayer .aplayer-lrc p.aplayer-lrc-current {
        
        display: none;
        
        font-size: 15px;
        color: #42b983;
    }

    
    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body {
        left: -66px !important;
    }

    .aplayer.aplayer-fixed.aplayer-narrow .aplayer-body:hover {
        left: 0px !important;
    }

    
</style>
<div class="">
    
    <div class="row">
        <meting-js class="col l8 offset-l2 m10 offset-m1 s12"
                   server="netease"
                   type="playlist"
                   id="503838841"
                   fixed='true'
                   autoplay='false'
                   theme='#42b983'
                   loop='all'
                   order='random'
                   preload='auto'
                   volume='0.7'
                   list-folded='true'
        >
        </meting-js>
    </div>
</div>

<script src="/libs/aplayer/APlayer.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/meting@2/dist/Meting.min.js"></script>

    
    <div class="container row center-align" style="margin-bottom: 0px !important;">
        <div class="col s12 m8 l8 copy-right">
            Copyright&nbsp;&copy;
            
                <span id="year">2019-2022</span>
            
            <span id="year">2019</span>
            <a href="/about" target="_blank">kanaikee</a>
            |&nbsp;Powered by&nbsp;<a href="https://hexo.io/" target="_blank">Hexo</a>
            |&nbsp;Theme&nbsp;<a href="https://github.com/blinkfox/hexo-theme-matery" target="_blank">Matery</a>
            <br>
            
            
            
            
            
            
            <span id="busuanzi_container_site_pv">
                |&nbsp;<i class="far fa-eye"></i>&nbsp;总访问量:&nbsp;<span id="busuanzi_value_site_pv"
                    class="white-color"></span>&nbsp;次
            </span>
            
            
            <span id="busuanzi_container_site_uv">
                |&nbsp;<i class="fas fa-users"></i>&nbsp;总访问人数:&nbsp;<span id="busuanzi_value_site_uv"
                    class="white-color"></span>&nbsp;人
            </span>
            
            <br>
            
            <br>
            
        </div>
        <div class="col s12 m4 l4 social-link social-statis">
    <a href="<https://github.com/koooolllll>" class="tooltipped" target="_blank" data-tooltip="访问我的GitHub" data-position="top" data-delay="50">
        <i class="fab fa-github"></i>
    </a>


<!-- 
    <a href="mailto:1181062873@qq.com" class="tooltipped" target="_blank" data-tooltip="邮件联系我" data-position="top" data-delay="50">
        <i class="fas fa-envelope-open"></i>
    </a>
 -->

<!--  -->

<!--  -->

<!-- 
    <a href="tencent://AddContact/?fromId=50&fromSubId=1&subcmd=all&uin=1181062873" class="tooltipped" target="_blank" data-tooltip="QQ联系我: 1181062873" data-position="top" data-delay="50">
        <i class="fab fa-qq"></i>
    </a>
 -->

<!-- 




    <a href="/atom.xml" class="tooltipped" target="_blank" data-tooltip="RSS 订阅" data-position="top" data-delay="50">
        <i class="fas fa-rss"></i>
    </a>
 -->
</div>
    </div>
</footer>

<div class="progress-bar"></div>


    <!-- 搜索遮罩框 -->
<div id="searchModal" class="modal">
    <div class="modal-content">
        <div class="search-header">
            <span class="title"><i class="fas fa-search"></i>&nbsp;&nbsp;搜索</span>
            <input type="search" id="searchInput" name="s" placeholder="请输入搜索的关键字"
                   class="search-input">
        </div>
        <div id="searchResult"></div>
    </div>
</div>

<script type="text/javascript">
$(function () {
    var searchFunc = function (path, search_id, content_id) {
        'use strict';
        $.ajax({
            url: path,
            dataType: "xml",
            success: function (xmlResponse) {
                // get the contents from search data
                var datas = $("entry", xmlResponse).map(function () {
                    return {
                        title: $("title", this).text(),
                        content: $("content", this).text(),
                        url: $("url", this).text()
                    };
                }).get();
                var $input = document.getElementById(search_id);
                var $resultContent = document.getElementById(content_id);
                $input.addEventListener('input', function () {
                    var str = '<ul class=\"search-result-list\">';
                    var keywords = this.value.trim().toLowerCase().split(/[\s\-]+/);
                    $resultContent.innerHTML = "";
                    if (this.value.trim().length <= 0) {
                        return;
                    }
                    // perform local searching
                    datas.forEach(function (data) {
                        var isMatch = true;
                        var data_title = data.title.trim().toLowerCase();
                        var data_content = data.content.trim().replace(/<[^>]+>/g, "").toLowerCase();
                        var data_url = data.url;
                        data_url = data_url.indexOf('/') === 0 ? data.url : '/' + data_url;
                        var index_title = -1;
                        var index_content = -1;
                        var first_occur = -1;
                        // only match artiles with not empty titles and contents
                        if (data_title !== '' && data_content !== '') {
                            keywords.forEach(function (keyword, i) {
                                index_title = data_title.indexOf(keyword);
                                index_content = data_content.indexOf(keyword);
                                if (index_title < 0 && index_content < 0) {
                                    isMatch = false;
                                } else {
                                    if (index_content < 0) {
                                        index_content = 0;
                                    }
                                    if (i === 0) {
                                        first_occur = index_content;
                                    }
                                }
                            });
                        }
                        // show search results
                        if (isMatch) {
                            str += "<li><a href='" + data_url + "' class='search-result-title'>" + data_title + "</a>";
                            var content = data.content.trim().replace(/<[^>]+>/g, "");
                            if (first_occur >= 0) {
                                // cut out 100 characters
                                var start = first_occur - 20;
                                var end = first_occur + 80;
                                if (start < 0) {
                                    start = 0;
                                }
                                if (start === 0) {
                                    end = 100;
                                }
                                if (end > content.length) {
                                    end = content.length;
                                }
                                var match_content = content.substr(start, end);
                                // highlight all keywords
                                keywords.forEach(function (keyword) {
                                    var regS = new RegExp(keyword, "gi");
                                    match_content = match_content.replace(regS, "<em class=\"search-keyword\">" + keyword + "</em>");
                                });

                                str += "<p class=\"search-result\">" + match_content + "...</p>"
                            }
                            str += "</li>";
                        }
                    });
                    str += "</ul>";
                    $resultContent.innerHTML = str;
                });
            }
        });
    };

    searchFunc('/search.xml', 'searchInput', 'searchResult');
});
</script>

    <!-- 回到顶部按钮 -->
<div id="backTop" class="top-scroll">
    <a class="btn-floating btn-large waves-effect waves-light" href="#!">
        <i class="fas fa-arrow-up"></i>
    </a>
</div>


    <script src="/libs/materialize/materialize.min.js"></script>
    <script src="/libs/masonry/masonry.pkgd.min.js"></script>
    <script src="/libs/aos/aos.js"></script>
    <script src="/libs/scrollprogress/scrollProgress.min.js"></script>
    <script src="/libs/lightGallery/js/lightgallery-all.min.js"></script>
    <script src="/js/matery.js"></script>

    <!-- Baidu Analytics -->

    <!-- Baidu Push -->

<script>
    (function () {
        var bp = document.createElement('script');
        var curProtocol = window.location.protocol.split(':')[0];
        if (curProtocol === 'https') {
            bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
        } else {
            bp.src = 'http://push.zhanzhang.baidu.com/push.js';
        }
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(bp, s);
    })();
</script>

    
    <script src="/libs/others/clicklove.js" async="async"></script>
    
    
    <script async src="/libs/others/busuanzi.pure.mini.js"></script>
    

    

    

	
    

    

    

    
    <script src="/libs/instantpage/instantpage.js" type="module"></script>
    

</body>

</html>
